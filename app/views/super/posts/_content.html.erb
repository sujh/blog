<section class="content">
  <div class="row">
    <%= render 'super/shared/folders' %>

    <div class="col-md-9">
      <div class="box box-primary">
        <div class="box-header with-border">
          <h3 class="box-title">
            <%= yield(:form_title) %>
          </h3>
        </div>

        <%= file_field_tag 'file', id: 'file-upload-field', style: 'display: none' %>
        <%= form_for([:super, @post], html: { id: 'record-form' }) do |f| %>
          <div class="box-body">
            <div class="form-group">
              <a href="javascript:;" id="file-upload-btn">
                <i class="fa fa-image"></i>
              </a>
            </div>
            <div class="form-group">
              <%= f.text_field(:title, class: 'form-control', placeholder: 'Title:', required: true, id: 'record-title') %>
            </div>

            <div class="form-group">
              <%= f.text_area(:content, class: 'form-control', id: 'record-content', placeholder: 'Content:', rows: 20, required: true) %>
              <div id="pre-area" style="display: none"></div>
            </div>
            <%= hidden_field_tag(:post_draft_id) if @post.new_record? %>
          </div>

          <div class="box-footer">
            <dv class="pull-left">
              <%= button_tag('保存草稿', type: 'button', class: 'btn btn-default btn-sm', id: 'draft-btn') %>
              <span id="suc-text" style="display: none; color: cadetblue">保存成功</span>
              <span id="fail-text" style="display: none; color: red">保存失败</span>
            </dv>

            <div class="pull-right">
              <%= button_tag('预览', type: 'button', class: 'btn btn-info btn-sm', id: 'pre-btn', style: 'cursor: pointer') %>
              <%= f.submit('完成', class: 'btn btn-primary btn-sm') %>
            </div>
          </div>
        <% end %>

      </div>
    </div>
  </div>
</section>
<% content_for :body_scripts do %>
  <script type="text/javascript">
    $('#pre-btn').click(function () {
      if ($('#pre-area').is(":hidden")) {
        $.ajax({
          url: '<%= preview_super_posts_url %>',
          type: 'get',
          data: {content: $('#record-content').val()},
          success: function (data) {
            $('#pre-btn').toggleClass('disabled');
            $('#pre-area').html(data).toggle();
            $('#record-content').toggle();
          }
        });
      } else {
        $('#pre-btn').toggleClass('disabled');
        $('#record-content').toggle();
        $('#pre-area').toggle();
      }
    });

    var body = $('body');
    $('#draft-btn').click(function () {
      var data = { title: $('#record-title').val(), content: $('#record-content').val(), draft_id: body.draft_id };
      <% if @post.persisted? %>
        data.post_id = <%= @post.id %>;
      <% end %>
      $.ajax({
        url: '<%= preserve_super_post_drafts_url %>',
        type: 'post',
        data: data,
        success: function (rsp) {
          if(rsp['code'] == 100){
            body.draft_id = rsp['data']['post_draft_id'];
            if($('#post_draft_id').length > 0){
              $('#post_draft_id').val(body.draft_id);
            }
            $('#suc-text').show().fadeOut(2000);
          } else {
            $('#fail-text').show().fadeOut(2000);
          }
        }
      });
    });

    $('#file-upload-btn').click(function(){
      $('#file-upload-field').click();
    });

    $('#file-upload-field').change(function(){
      var formData = new FormData();
      formData.append('image', document.getElementById('file-upload-field').files[0]);
      $.post({
        url: '<%= photos_path %>',
        data: formData,
        processData: false,
        contentType: false,
        success: function(rsp){
          if(rsp['code'] == 100){
            var img_url = '![](' + rsp['data']['url'] + ')';
            var $content_area = $('#record-content');
            $content_area.val($content_area.val() + img_url);
          }
        }
      });
    })
  </script>
<% end %>